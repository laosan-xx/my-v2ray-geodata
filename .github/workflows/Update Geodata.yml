name: Update Geodata

on:
  schedule:
    # 每天 UTC 时间 0:00 运行（北京时间 8:00）
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限以提交更改
      actions: write   # 需要写入权限以删除 workflow 运行历史
    
    steps:
      - name: Clean up old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取当前 workflow 的所有运行记录（排除当前运行）
          gh run list --workflow="${{ github.workflow }}" --repo=${{ github.repository }} --json databaseId --jq '.[].databaseId' | while read run_id; do
            if [ "$run_id" != "${{ github.run_id }}" ]; then
              echo "Deleting workflow run: $run_id"
              gh run delete "$run_id" --repo=${{ github.repository }} || true
            fi
          done

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # ubuntu-latest 已预装 gh 和 jq，无需手动安装

      - name: Run update script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x update.sh
          # 运行更新脚本
          # 返回码 0: 成功更新
          # 返回码 2: 版本相同，无需更新（正常情况）
          # 返回码 1: 错误（如网络问题、API 失败等）
          bash update.sh
          exit_code=$?
          if [ $exit_code -eq 1 ]; then
            echo "Error: Failed to update geodata (exit code: $exit_code)"
            exit 1
          fi
          echo "Update script completed (exit code: $exit_code)"

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          branch=$(git branch --show-current || echo "main")
          
          # 检查上一次提交是否是自动更新提交
          last_commit_msg=$(git log -1 --pretty=%s 2>/dev/null || echo "")
          
          git add Makefile
          
          if [[ "$last_commit_msg" == "chore: update geodata versions"* ]]; then
            # 如果上次提交也是自动更新，则修改该提交（覆盖历史）
            git commit --amend -m "chore: update geodata versions [skip ci]"
            git push origin HEAD:$branch --force
          else
            # 否则创建新提交
            git commit -m "chore: update geodata versions [skip ci]"
            git push origin HEAD:$branch
          fi
